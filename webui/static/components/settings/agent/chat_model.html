<html>

<head>
  <title>Chat Model</title>
</head>

<body>
  <script type="module">
    import * as API from "/js/api.js";
    window._chatModelAPI = API;
  </script>
  <div x-data="{
      modelsList: [],
      modelsLoading: false,
      modelsError: '',
      previousProvider: '',
      useDropdown: false,
      _fetchTimer: null,

      async fetchModels() {
        const settings = $store.settings.settings;
        if (!settings) return;
        const provider = (settings.chat_model_provider || '').toLowerCase();
        const apiKey = (settings.api_keys || {})[settings.chat_model_provider] || '';
        const apiBase = settings.chat_model_api_base || '';

        if (!provider) return;
        if (!apiKey && provider !== 'ollama') return;

        this.modelsLoading = true;
        this.modelsError = '';
        try {
          const response = await window._chatModelAPI.callJsonApi('models_list', {
            provider, api_key: apiKey, api_base: apiBase
          });

          if (response && response.ok && response.models && response.models.length > 0) {
            this.modelsList = response.models;
            this.useDropdown = true;
            this.modelsError = '';
            // Populate the select element via JS since Alpine x-for in <select> is unreliable
            this.$nextTick(() => this.populateSelect());
          } else {
            this.modelsError = (response && response.error) || 'No models found. Check your API key.';
            this.modelsList = [];
            this.useDropdown = false;
          }
        } catch (e) {
          this.modelsError = 'Network error: ' + (e.message || e);
          this.modelsList = [];
          this.useDropdown = false;
        } finally {
          this.modelsLoading = false;
        }
      },

      populateSelect() {
        const sel = this.$refs.modelSelect;
        if (!sel) return;

        // Save current value
        const currentVal = $store.settings.settings.chat_model_name || '';

        // Clear and rebuild options
        sel.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = '-- Select a model (' + this.modelsList.length + ' available) --';
        sel.appendChild(defaultOpt);

        for (const m of this.modelsList) {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name !== m.id ? m.name + ' (' + m.id + ')' : m.id;
          if (m.id === currentVal) opt.selected = true;
          sel.appendChild(opt);
        }

        // Restore selection
        if (currentVal) sel.value = currentVal;
      },

      onSelectChange(event) {
        $store.settings.settings.chat_model_name = event.target.value;
      },

      switchToManual() {
        this.useDropdown = false;
        this.modelsList = [];
      },

      autoFillEndpoint() {
        const settings = $store.settings.settings;
        if (!settings) return;
        const provider = (settings.chat_model_provider || '').toLowerCase();
        const endpoints = $store.settings.additional?.provider_endpoints || {};

        if (provider !== this.previousProvider) {
          const prevEndpoint = endpoints[this.previousProvider] || '';
          const currentBase = settings.chat_model_api_base || '';

          if (!currentBase || currentBase === prevEndpoint) {
            settings.chat_model_api_base = endpoints[provider] || '';
          }
          this.previousProvider = provider;
          this.useDropdown = false;
          this.modelsList = [];
          // Auto-fetch if key exists for new provider
          this.debouncedFetch();
        }
      },

      debouncedFetch() {
        clearTimeout(this._fetchTimer);
        this._fetchTimer = setTimeout(() => this.fetchModels(), 800);
      },

      watchApiKey() {
        const settings = $store.settings.settings;
        if (!settings) return;
        const provider = settings.chat_model_provider || '';
        const apiKey = (settings.api_keys || {})[provider] || '';
        // Auto-fetch when key looks valid (at least 10 chars)
        if (apiKey.length >= 10) {
          this.debouncedFetch();
        }
      }
    }" x-init="previousProvider = ($store.settings.settings?.chat_model_provider || '').toLowerCase()"
    x-effect="autoFillEndpoint(); watchApiKey()">
    <template x-if="$store.settings.settings">
      <div>
        <div class="section-title">Chat Model</div>
        <div class="section-description">
          Selection and settings for main chat model used by Agent Zero
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model provider</div>
            <div class="field-description">Select provider for main chat model used by Agent Zero</div>
          </div>
          <div class="field-control">
            <select x-model="$store.settings.settings.chat_model_provider">
              <template x-for="option in $store.settings.additional?.chat_providers" :key="option.value">
                <option :value="option.value" :selected="option.value === $store.settings.settings.chat_model_provider"
                  x-text="option.label"></option>
              </template>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model name</div>
            <div class="field-description">
              <span x-show="!useDropdown">Type a model name, or enter your API key below to auto-load available
                models.</span>
              <span x-show="useDropdown" x-text="modelsList.length + ' models loaded from provider'"></span>
            </div>
          </div>
          <div class="field-control" style="display: flex; flex-direction: column; gap: 6px;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <!-- Dropdown mode: native select populated via JS -->
              <select x-ref="modelSelect" x-show="useDropdown" @change="onSelectChange($event)" style="flex: 1;">
                <option value="">-- Select a model --</option>
              </select>
              <!-- Manual mode: text input -->
              <input x-show="!useDropdown" type="text" x-model="$store.settings.settings.chat_model_name"
                placeholder="e.g. gpt-4o or gemini-2.5-pro" style="flex: 1;" />
              <!-- Loading indicator -->
              <span x-show="modelsLoading"
                style="font-size: 13px; color: var(--color-text-muted, #888); white-space: nowrap;">‚è≥ Loading
                models...</span>
            </div>
            <!-- Toggle link -->
            <div x-show="useDropdown" style="font-size: 12px; color: var(--color-text-muted, #888);">
              <span style="cursor: pointer; text-decoration: underline; color: var(--color-primary, #6ea8fe);"
                @click="switchToManual()">Switch to manual entry</span>
            </div>
            <div x-show="modelsError" style="font-size: 12px; color: #ff6b6b;" x-text="modelsError"></div>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">API key</div>
            <div class="field-description">API key for the selected chat model provider. Models will auto-load when a
              valid key is entered.</div>
          </div>
          <div class="field-control">
            <input type="text" x-model="$store.settings.settings.api_keys[$store.settings.settings.chat_model_provider]"
              autocomplete="off" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model API base URL</div>
            <div class="field-description">
              API base URL for main chat model. Auto-filled for known providers. Override for custom endpoints.
            </div>
          </div>
          <div class="field-control">
            <input type="text" x-model="$store.settings.settings.chat_model_api_base"
              placeholder="Auto-filled for known providers" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model context length</div>
            <div class="field-description">
              Maximum number of tokens in the context window for LLM. System prompt, chat history, RAG and response all
              count towards this limit.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_ctx_length" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Context window space for chat history</div>
            <div class="field-description">
              Portion of context window dedicated to chat history visible to the agent. Chat history will automatically
              be optimized to fit.
            </div>
          </div>
          <div class="field-control">
            <input type="range" min="0.01" max="1" step="0.01"
              x-model.number="$store.settings.settings.chat_model_ctx_history" />
            <span class="range-value" x-text="$store.settings.settings.chat_model_ctx_history"></span>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Supports Vision</div>
            <div class="field-description">
              Models capable of Vision can for example natively see the content of image attachments.
            </div>
          </div>
          <div class="field-control">
            <label class="toggle">
              <input type="checkbox" x-model="$store.settings.settings.chat_model_vision" />
              <span class="toggler"></span>
            </label>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Requests per minute limit</div>
            <div class="field-description">
              Limits the number of requests per minute to the chat model. Set to 0 to disable rate limiting.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_rl_requests" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Input tokens per minute limit</div>
            <div class="field-description">
              Limits the number of input tokens per minute to the chat model. Set to 0 to disable rate limiting.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_rl_input" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Output tokens per minute limit</div>
            <div class="field-description">
              Limits the number of output tokens per minute to the chat model. Set to 0 to disable rate limiting.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_rl_output" />
          </div>
        </div>

        <div class="field field-full">
          <div class="field-label">
            <div class="field-title">Chat model additional parameters</div>
            <div class="field-description">
              Any other parameters supported by <a href='https://docs.litellm.ai/docs/set_keys'
                target='_blank'>LiteLLM</a>. Format is KEY=VALUE on individual lines, like .env file.
            </div>
          </div>
          <div class="field-control">
            <textarea x-model="$store.settings.settings.chat_model_kwargs"></textarea>
          </div>
        </div>
      </div>
    </template>
  </div>
</body>

</html>