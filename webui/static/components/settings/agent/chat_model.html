<html>

<head>
  <title>Chat Model</title>
</head>

<body>
  <script type="module">
    import * as API from "/js/api.js";
    window._chatModelAPI = API;
  </script>
  <div x-data="{
      modelsList: [],
      modelsLoading: false,
      modelsError: '',
      previousProvider: '',

      async fetchModels() {
        const settings = $store.settings.settings;
        if (!settings) return;
        const provider = settings.chat_model_provider || '';
        const apiKey = (settings.api_keys || {})[provider] || '';
        const apiBase = settings.chat_model_api_base || '';

        if (!provider) {
          this.modelsError = 'Please select a provider first';
          return;
        }

        this.modelsLoading = true;
        this.modelsError = '';
        try {
          const response = await window._chatModelAPI.callJsonApi('models_list', { provider, api_key: apiKey, api_base: apiBase });

          if (response.ok && response.models) {
            this.modelsList = response.models;
            if (response.models.length === 0) {
              this.modelsError = 'No models found. Check your API key.';
            }
          } else {
            this.modelsError = response.error || 'Failed to fetch models';
            this.modelsList = [];
          }
        } catch (e) {
          this.modelsError = 'Network error: ' + e.message;
          this.modelsList = [];
        } finally {
          this.modelsLoading = false;
        }
      },

      autoFillEndpoint() {
        const settings = $store.settings.settings;
        if (!settings) return;
        const provider = (settings.chat_model_provider || '').toLowerCase();
        const endpoints = $store.settings.additional?.provider_endpoints || {};

        // Only auto-fill if provider actually changed and base is empty or was auto-filled
        if (provider !== this.previousProvider) {
          const prevEndpoint = endpoints[this.previousProvider] || '';
          const currentBase = settings.chat_model_api_base || '';

          // Auto-fill if empty or if it matches the previous provider's default
          if (!currentBase || currentBase === prevEndpoint) {
            const newEndpoint = endpoints[provider] || '';
            settings.chat_model_api_base = newEndpoint;
          }
          this.previousProvider = provider;
          // Clear model list when provider changes
          this.modelsList = [];
        }
      }
    }" x-init="previousProvider = ($store.settings.settings?.chat_model_provider || '').toLowerCase()"
    x-effect="autoFillEndpoint()">
    <template x-if="$store.settings.settings">
      <div>
        <div class="section-title">Chat Model</div>
        <div class="section-description">
          Selection and settings for main chat model used by Agent Zero
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model provider</div>
            <div class="field-description">Select provider for main chat model used by Agent Zero</div>
          </div>
          <div class="field-control">
            <select x-model="$store.settings.settings.chat_model_provider">
              <template x-for="option in $store.settings.additional?.chat_providers" :key="option.value">
                <option :value="option.value" :selected="option.value === $store.settings.settings.chat_model_provider"
                  x-text="option.label"></option>
              </template>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model name</div>
            <div class="field-description">Select a model or type one manually. Click "Fetch Models" to load available
              models from the provider.</div>
          </div>
          <div class="field-control" style="display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <template x-if="modelsList.length > 0">
                <select x-model="$store.settings.settings.chat_model_name" style="flex: 1;">
                  <option value="">-- Select a model --</option>
                  <template x-for="m in modelsList" :key="m.id">
                    <option :value="m.id" x-text="m.name + (m.name !== m.id ? ' (' + m.id + ')' : '')"></option>
                  </template>
                </select>
              </template>
              <template x-if="modelsList.length === 0">
                <input type="text" x-model="$store.settings.settings.chat_model_name"
                  placeholder="e.g. gpt-4o or gemini-2.5-pro" style="flex: 1;" />
              </template>
              <button @click="fetchModels()" :disabled="modelsLoading"
                style="white-space: nowrap; padding: 8px 16px; border-radius: 6px; border: 1px solid var(--color-border, #444); background: var(--color-surface, #2a2a2a); color: var(--color-text, #eee); cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;"
                :style="modelsLoading ? 'opacity: 0.6; cursor: wait;' : ''">
                <span x-show="!modelsLoading">üîÑ Fetch Models</span>
                <span x-show="modelsLoading">‚è≥ Loading...</span>
              </button>
            </div>
            <div x-show="modelsList.length > 0" style="font-size: 12px; color: var(--color-text-muted, #888);">
              <span x-text="modelsList.length + ' models available'"></span>
              <span
                style="margin-left: 8px; cursor: pointer; text-decoration: underline; color: var(--color-primary, #6ea8fe);"
                @click="modelsList = []">Switch to manual entry</span>
            </div>
            <div x-show="modelsError" style="font-size: 12px; color: #ff6b6b;" x-text="modelsError"></div>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">API key</div>
            <div class="field-description">API key for the selected chat model provider</div>
          </div>
          <div class="field-control">
            <input type="text" x-model="$store.settings.settings.api_keys[$store.settings.settings.chat_model_provider]"
              autocomplete="off" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model API base URL</div>
            <div class="field-description">
              API base URL for main chat model. Auto-filled for known providers. Override for custom endpoints.
            </div>
          </div>
          <div class="field-control">
            <input type="text" x-model="$store.settings.settings.chat_model_api_base"
              placeholder="Auto-filled for known providers" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Chat model context length</div>
            <div class="field-description">
              Maximum number of tokens in the context window for LLM. System prompt, chat history, RAG and response all
              count towards this limit.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_ctx_length" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Context window space for chat history</div>
            <div class="field-description">
              Portion of context window dedicated to chat history visible to the agent. Chat history will automatically
              be optimized to fit. Smaller size will result in shorter and more summarized history. The remaining space
              will be used for system prompt, RAG and response.
            </div>
          </div>
          <div class="field-control">
            <input type="range" min="0.01" max="1" step="0.01"
              x-model.number="$store.settings.settings.chat_model_ctx_history" />
            <span class="range-value" x-text="$store.settings.settings.chat_model_ctx_history"></span>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Supports Vision</div>
            <div class="field-description">
              Models capable of Vision can for example natively see the content of image attachments.
            </div>
          </div>
          <div class="field-control">
            <label class="toggle">
              <input type="checkbox" x-model="$store.settings.settings.chat_model_vision" />
              <span class="toggler"></span>
            </label>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Requests per minute limit</div>
            <div class="field-description">
              Limits the number of requests per minute to the chat model. Waits if the limit is exceeded. Set to 0 to
              disable rate limiting.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_rl_requests" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Input tokens per minute limit</div>
            <div class="field-description">
              Limits the number of input tokens per minute to the chat model. Waits if the limit is exceeded. Set to 0
              to disable rate limiting.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_rl_input" />
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <div class="field-title">Output tokens per minute limit</div>
            <div class="field-description">
              Limits the number of output tokens per minute to the chat model. Waits if the limit is exceeded. Set to 0
              to disable rate limiting.
            </div>
          </div>
          <div class="field-control">
            <input type="number" x-model.number="$store.settings.settings.chat_model_rl_output" />
          </div>
        </div>

        <div class="field field-full">
          <div class="field-label">
            <div class="field-title">Chat model additional parameters</div>
            <div class="field-description">
              Any other parameters supported by <a href='https://docs.litellm.ai/docs/set_keys'
                target='_blank'>LiteLLM</a>. Format is KEY=VALUE on individual lines, like .env file. Value can also
              contain JSON objects - when unquoted, it is treated as object, number etc., when quoted, it is treated as
              string.
            </div>
          </div>
          <div class="field-control">
            <textarea x-model="$store.settings.settings.chat_model_kwargs"></textarea>
          </div>
        </div>
      </div>
    </template>
  </div>
</body>

</html>